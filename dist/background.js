import{s as r}from"./assets/storage-BmJBOsSV.js";import{c as y}from"./assets/riskEngine-B9g6v8WF.js";function p(e,a,m){chrome.notifications.create({type:"basic",iconUrl:"../icons/icon48.png",title:"Biztonsági Figyelmeztetés",message:`A(z) ${e} bővítmény gyanús változást mutat:
${a}`,buttons:[{title:"Áttekintés"},{title:"Figyelmen kívül hagyás"}],priority:2})}async function b(){return new Promise(e=>{chrome.management.getAll(a=>{const m={},o=chrome.runtime.id;for(const s of a)s.id!==o&&(m[s.id]={id:s.id,name:s.name,version:s.version,enabled:s.enabled,installType:s.installType,updateUrl:s.updateUrl||"",permissions:s.permissions||[],hostPermissions:s.hostPermissions||[]});e(m)})})}async function c(e,a){const m=await b(),o=await r.getBaseline(),s=await r.getConfig();let f=!1;const h=async(t,i,n)=>{const l=y(i,n,s);if(l.score>=70&&e!=="disabled"&&e!=="uninstalled"){const d=l.reasons.length>0?l.reasons[0]:"Magas kockázatú engedélyek.";p(i.name,d,i.id)}if(e!=="updated"||n&&(n.version!==i.version||n.enabled!==i.enabled)){const d=[];n&&n.version!==i.version&&d.push(`Frissítve: ${n.version} -> ${i.version}`),n&&n.enabled!==i.enabled&&d.push(i.enabled?"Engedélyezve":"Kikapcsolva");const g=e==="updated"?n?.version!==i.version?"updated":n?.enabled!==i.enabled?i.enabled?"enabled":"disabled":"permissions_changed":e;(g!=="updated"||d.length>0)&&await r.addAuditLogEntry({extensionId:i.id,extensionName:i.name,eventType:g,riskScore:l.score,reasons:l.reasons,diffSummary:d.join(", ")})}n&&(i.previousPermissions=n.permissions,i.previousHostPermissions=n.hostPermissions),o[t]=i,f=!0};for(const[t,i]of Object.entries(m)){const n=o[t];if(!n)await h(t,i);else{const l=n.version!==i.version,d=n.enabled!==i.enabled,g=JSON.stringify(n.permissions)!==JSON.stringify(i.permissions),u=JSON.stringify(n.hostPermissions)!==JSON.stringify(i.hostPermissions);(l||d||g||u)&&await h(t,i,n)}}for(const t of Object.keys(o))m[t]||(await r.addAuditLogEntry({extensionId:t,extensionName:o[t].name,eventType:"uninstalled",diffSummary:"Bővítmény eltávolítva."}),delete o[t],f=!0);f&&await r.saveBaseline(o)}async function v(){const e=await r.getBaseline();if(Object.keys(e).length===0){const a=await b();await r.saveBaseline(a),console.log("Trust Monitor: Kezdeti állapot (baseline) rögzítve.")}else await c("updated")}console.log("Trust Monitor Background Service Worker elindítva.");chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create("periodic-scan",{periodInMinutes:360})});v();chrome.alarms.onAlarm.addListener(e=>{e.name==="periodic-scan"&&c("updated")});chrome.management.onInstalled.addListener(e=>{e.id!==chrome.runtime.id&&c("installed",e.id)});chrome.management.onUninstalled.addListener(e=>{e!==chrome.runtime.id&&c("uninstalled")});chrome.management.onEnabled.addListener(e=>{e.id!==chrome.runtime.id&&c("enabled",e.id)});chrome.management.onDisabled.addListener(e=>{e.id!==chrome.runtime.id&&c("disabled",e.id)});chrome.notifications.onButtonClicked.addListener((e,a)=>{a===0&&chrome.tabs.create({url:chrome.runtime.getURL("src/ui/pages/dashboard.html")})});
