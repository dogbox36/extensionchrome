const f=new Set(["management","cookies","webRequest","declarativeNetRequest","debugger","downloads","history","nativeMessaging","proxy","privacy","tabCapture"]),b=["mail.google.com","drive.google.com","docs.google.com","web.whatsapp.com","outlook.office.com"];function p(e,t){let n=0;const o=[],a=[],m=e.permissions.filter(l=>f.has(l));m.length>0&&(n+=Math.min(m.length*15,50),o.push(`Szenzitív API jogosultságokat használ: ${m.join(", ")}.`));let d=!1;const s=[];for(const l of e.hostPermissions){(l.includes("<all_urls>")||l.includes("*://*/*"))&&(d=!0);for(const r of b)l.includes(r)&&s.push(r)}if(d&&(n+=40,o.push("Minden weboldalhoz hozzáférést kér (<all_urls> vagy globális minta).")),s.length>0&&(n+=s.length*10,o.push(`Szenzitív weboldalakhoz (pl. levelezés, dokumentumok) kér hozzáférést: ${s.join(", ")}.`)),e.permissions.includes("scripting")&&e.hostPermissions.length>0&&(n+=15,o.push("Képes scripteket futtatni a meglátogatott weboldalakon (Content injection rizikó).")),t&&t.version!==e.version){const l=e.permissions.filter(c=>!t.permissions.includes(c)&&f.has(c)),r=e.hostPermissions.filter(c=>!t.hostPermissions.includes(c)&&(c.includes("<all_urls>")||b.some(u=>c.includes(u))));(l.length>0||r.length>0)&&(n+=20,o.push("A legutóbbi frissítés során hirtelen új, szenzitív jogosultságokat kért."))}return n=Math.min(n,100),n>=70?a.push("Erősen javasolt a bővítmény kikapcsolása vagy eltávolítása, ha nem feltétlenül szükséges."):n>=40&&a.push("Érdemes átgondolni, hogy valóban szükség van-e a bővítmény által kért jogokra."),{score:n,reasons:o,recommendedActions:a}}const g={async get(e){return(await chrome.storage.local.get(e))[e]||null},async set(e,t){await chrome.storage.local.set({[e]:t})},async getBaseline(){return await this.get("extensionsBaseline")||{}},async saveBaseline(e){await this.set("extensionsBaseline",e)},async getAuditLog(){return await this.get("auditLog")||[]},async addAuditLogEntry(e){const t=await this.getAuditLog(),n={...e,id:crypto.randomUUID(),timestamp:Date.now()};t.unshift(n),t.length>500&&t.pop(),await this.set("auditLog",t)}};function v(e,t,n){chrome.notifications.create({type:"basic",iconUrl:"../icons/icon48.png",title:"Biztonsági Figyelmeztetés",message:`A(z) ${e} bővítmény gyanús változást mutat:
${t}`,buttons:[{title:"Áttekintés"},{title:"Figyelmen kívül hagyás"}],priority:2})}async function y(){return new Promise(e=>{chrome.management.getAll(t=>{const n={},o=chrome.runtime.id;for(const a of t)a.id!==o&&(n[a.id]={id:a.id,name:a.name,version:a.version,enabled:a.enabled,installType:a.installType,updateUrl:a.updateUrl||"",permissions:a.permissions||[],hostPermissions:a.hostPermissions||[]});e(n)})})}async function h(e,t){const n=await y(),o=await g.getBaseline();let a=!1;const m=async(d,s,i)=>{const l=p(s,i);if(l.score>=70&&e!=="disabled"&&e!=="uninstalled"){const r=l.reasons.length>0?l.reasons[0]:"Magas kockázatú engedélyek.";v(s.name,r,s.id)}if(e!=="updated"||i&&(i.version!==s.version||i.enabled!==s.enabled)){const r=[];i&&i.version!==s.version&&r.push(`Frissítve: ${i.version} -> ${s.version}`),i&&i.enabled!==s.enabled&&r.push(s.enabled?"Engedélyezve":"Kikapcsolva");const c=e==="updated"?i?.version!==s.version?"updated":i?.enabled!==s.enabled?s.enabled?"enabled":"disabled":"permissions_changed":e;(c!=="updated"||r.length>0)&&await g.addAuditLogEntry({extensionId:s.id,extensionName:s.name,eventType:c,riskScore:l.score,reasons:l.reasons,diffSummary:r.join(", ")})}o[d]=s,a=!0};for(const[d,s]of Object.entries(n)){const i=o[d];if(!i)await m(d,s);else{const l=i.version!==s.version,r=i.enabled!==s.enabled,c=JSON.stringify(i.permissions)!==JSON.stringify(s.permissions),u=JSON.stringify(i.hostPermissions)!==JSON.stringify(s.hostPermissions);(l||r||c||u)&&await m(d,s,i)}}for(const d of Object.keys(o))n[d]||(await g.addAuditLogEntry({extensionId:d,extensionName:o[d].name,eventType:"uninstalled",diffSummary:"Bővítmény eltávolítva."}),delete o[d],a=!0);a&&await g.saveBaseline(o)}async function w(){const e=await g.getBaseline();if(Object.keys(e).length===0){const t=await y();await g.saveBaseline(t),console.log("Trust Monitor: Kezdeti állapot (baseline) rögzítve.")}else await h("updated")}console.log("Trust Monitor Background Service Worker elindítva.");chrome.runtime.onInstalled.addListener(()=>{w(),chrome.alarms.create("periodic-scan",{periodInMinutes:360})});chrome.alarms.onAlarm.addListener(e=>{e.name==="periodic-scan"&&h("updated")});chrome.management.onInstalled.addListener(e=>{e.id!==chrome.runtime.id&&h("installed",e.id)});chrome.management.onUninstalled.addListener(e=>{e!==chrome.runtime.id&&h("uninstalled")});chrome.management.onEnabled.addListener(e=>{e.id!==chrome.runtime.id&&h("enabled",e.id)});chrome.management.onDisabled.addListener(e=>{e.id!==chrome.runtime.id&&h("disabled",e.id)});chrome.notifications.onButtonClicked.addListener((e,t)=>{t===0&&chrome.tabs.create({url:chrome.runtime.getURL("src/ui/pages/dashboard.html")})});
