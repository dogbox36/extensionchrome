import{c as b}from"./assets/riskEngine-D4_ttAbt.js";const c={async get(e){return(await chrome.storage.local.get(e))[e]||null},async set(e,i){await chrome.storage.local.set({[e]:i})},async getBaseline(){return await this.get("extensionsBaseline")||{}},async saveBaseline(e){await this.set("extensionsBaseline",e)},async getAuditLog(){return await this.get("auditLog")||[]},async addAuditLogEntry(e){const i=await this.getAuditLog(),o={...e,id:crypto.randomUUID(),timestamp:Date.now()};i.unshift(o),i.length>500&&i.pop(),await this.set("auditLog",i)}};function y(e,i,o){chrome.notifications.create({type:"basic",iconUrl:"../icons/icon48.png",title:"Biztonsági Figyelmeztetés",message:`A(z) ${e} bővítmény gyanús változást mutat:
${i}`,buttons:[{title:"Áttekintés"},{title:"Figyelmen kívül hagyás"}],priority:2})}async function f(){return new Promise(e=>{chrome.management.getAll(i=>{const o={},d=chrome.runtime.id;for(const a of i)a.id!==d&&(o[a.id]={id:a.id,name:a.name,version:a.version,enabled:a.enabled,installType:a.installType,updateUrl:a.updateUrl||"",permissions:a.permissions||[],hostPermissions:a.hostPermissions||[]});e(o)})})}async function m(e,i){const o=await f(),d=await c.getBaseline();let a=!1;const h=async(s,t,n)=>{const l=b(t,n);if(l.score>=70&&e!=="disabled"&&e!=="uninstalled"){const r=l.reasons.length>0?l.reasons[0]:"Magas kockázatú engedélyek.";y(t.name,r,t.id)}if(e!=="updated"||n&&(n.version!==t.version||n.enabled!==t.enabled)){const r=[];n&&n.version!==t.version&&r.push(`Frissítve: ${n.version} -> ${t.version}`),n&&n.enabled!==t.enabled&&r.push(t.enabled?"Engedélyezve":"Kikapcsolva");const g=e==="updated"?n?.version!==t.version?"updated":n?.enabled!==t.enabled?t.enabled?"enabled":"disabled":"permissions_changed":e;(g!=="updated"||r.length>0)&&await c.addAuditLogEntry({extensionId:t.id,extensionName:t.name,eventType:g,riskScore:l.score,reasons:l.reasons,diffSummary:r.join(", ")})}d[s]=t,a=!0};for(const[s,t]of Object.entries(o)){const n=d[s];if(!n)await h(s,t);else{const l=n.version!==t.version,r=n.enabled!==t.enabled,g=JSON.stringify(n.permissions)!==JSON.stringify(t.permissions),u=JSON.stringify(n.hostPermissions)!==JSON.stringify(t.hostPermissions);(l||r||g||u)&&await h(s,t,n)}}for(const s of Object.keys(d))o[s]||(await c.addAuditLogEntry({extensionId:s,extensionName:d[s].name,eventType:"uninstalled",diffSummary:"Bővítmény eltávolítva."}),delete d[s],a=!0);a&&await c.saveBaseline(d)}async function p(){const e=await c.getBaseline();if(Object.keys(e).length===0){const i=await f();await c.saveBaseline(i),console.log("Trust Monitor: Kezdeti állapot (baseline) rögzítve.")}else await m("updated")}console.log("Trust Monitor Background Service Worker elindítva.");chrome.runtime.onInstalled.addListener(()=>{chrome.alarms.create("periodic-scan",{periodInMinutes:360})});p();chrome.alarms.onAlarm.addListener(e=>{e.name==="periodic-scan"&&m("updated")});chrome.management.onInstalled.addListener(e=>{e.id!==chrome.runtime.id&&m("installed",e.id)});chrome.management.onUninstalled.addListener(e=>{e!==chrome.runtime.id&&m("uninstalled")});chrome.management.onEnabled.addListener(e=>{e.id!==chrome.runtime.id&&m("enabled",e.id)});chrome.management.onDisabled.addListener(e=>{e.id!==chrome.runtime.id&&m("disabled",e.id)});chrome.notifications.onButtonClicked.addListener((e,i)=>{i===0&&chrome.tabs.create({url:chrome.runtime.getURL("src/ui/pages/dashboard.html")})});
